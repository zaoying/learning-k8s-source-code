# Resource Helper分析

package Resource 帮助kubectl处理符合Kubernetes API约定的RESTful对象。 
Helper对象在资源上提供了简单的CRUD操作。

Visitor界面可以轻松地对多个资源进行检索和操作。 
Builder对象简化了将标准命令行和参数转换为Visitor的功能，该Visitor可以迭代所有已标识的资源，无论是在服务器上还是在本地文件系统上。

前面说到kubectl是通过各种Client，与Kube-apiserver进行通信的。 
Resource Helper就是负责调用这些Client，把信息发送给Kube-apiserver。 
见/pkg/kubectl/resource/helper.go

## type Helper struct
Helper对象在资源上提供了简单的CRUD操作，任意一个对资源的操作，都会新建一个type Helper struct对象，由Helper对象来触发相应的Restful动作。
```go
// Helper provides methods for retrieving or mutating a RESTful
// resource.
type Helper struct {
	// The name of this resource as the server would recognize it
	Resource string
	// A RESTClient capable of mutating this resource.
	RESTClient RESTClient
	// An interface for reading or writing the resource version of this
	// type.
	Versioner runtime.ResourceVersioner
	// True if the resource type is scoped to namespaces
	NamespaceScoped bool
}
```

## func NewHelper()
根据mapping *meta.RESTMapping来是创建一个Helper对象。
```go
// NewHelper creates a Helper from a ResourceMapping
func NewHelper(client RESTClient, mapping *meta.RESTMapping) *Helper {
	return &Helper{
		Resource:        mapping.Resource,
		RESTClient:      client,
		Versioner:       mapping.MetadataAccessor,
		NamespaceScoped: mapping.Scope.Name() == meta.RESTScopeNameNamespace,
	}
}
```
### 以List命令来看Helper的创建过程
`kubectl get nodes` 实质上触发的是Helper的List动作，而`kubectl get node xxx` 触发的是Helper的Get动作。 

其调用栈如下所示，可以发现这里的由Visitor来触发的。

```txt
k8s.io/kubernetes/pkg/kubectl/resource.NewHelper(0x2057360, 0xc420314a80, 0xc420412070, 0x7)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/resource/helper.go:47 +0x26
k8s.io/kubernetes/pkg/kubectl/resource.(*Selector).Visit(0xc420017b40, 0xc4201cd920, 0x0, 0xc42017a770)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/resource/selector.go:58 +0x58
k8s.io/kubernetes/pkg/kubectl/resource.EagerVisitorList.Visit(0xc42017a6f0, 0x1, 0x1, 0xc4201108a0, 0x1, 0xc4201108a0)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/resource/visitor.go:245 +0xf4
k8s.io/kubernetes/pkg/kubectl/resource.(*EagerVisitorList).Visit(0xc4201cd820, 0xc4201108a0, 0x0, 0x1872db6)
	<autogenerated>:124 +0x6e
k8s.io/kubernetes/pkg/kubectl/resource.FlattenListVisitor.Visit(0x2047f80, 0xc4201cd820, 0xc420017140, 0xc420017b80, 0xc4201cd801, 0xc420017b80)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/resource/visitor.go:496 +0x94
k8s.io/kubernetes/pkg/kubectl/resource.(*FlattenListVisitor).Visit(0xc4201cd840, 0xc420017b80, 0x18, 0x18)
	<autogenerated>:140 +0x6e
k8s.io/kubernetes/pkg/kubectl/resource.DecoratedVisitor.Visit(0x2048000, 0xc4201cd840, 0xc4201cd880, 0x3, 0x4, 0xc4201cd8e0, 0x40e601, 0xc4201cd8e0)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/resource/visitor.go:374 +0xd6
k8s.io/kubernetes/pkg/kubectl/resource.(*DecoratedVisitor).Visit(0xc420110870, 0xc4201cd8e0, 0x0, 0x10)
	<autogenerated>:160 +0x78
k8s.io/kubernetes/pkg/kubectl/resource.ContinueOnErrorVisitor.Visit(0x2047f00, 0xc420110870, 0xc42017a7b0, 0x16223e0, 0x1796301)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/resource/visitor.go:412 +0xf1
k8s.io/kubernetes/pkg/kubectl/resource.(*ContinueOnErrorVisitor).Visit(0xc42017a720, 0xc42017a7b0, 0x11, 0x1785eb5)
	<autogenerated>:155 +0x65
k8s.io/kubernetes/pkg/kubectl/resource.(*Result).Infos(0xc4204128c0, 0x0, 0x0, 0x0, 0x0, 0x0)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/resource/result.go:131 +0xfd
k8s.io/kubernetes/pkg/kubectl/cmd.RunGet(0x205fd60, 0xc420445f80, 0x2047000, 0xc420024010, 0x2047000, 0xc420024018, 0xc420448000, 0xc42040d580, 0x1, 0x1, ...)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/cmd/get.go:484 +0x1f7e
k8s.io/kubernetes/pkg/kubectl/cmd.NewCmdGet.func1(0xc420448000, 0xc42040d580, 0x1, 0x1)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/cmd/get.go:107 +0x95
k8s.io/kubernetes/vendor/github.com/spf13/cobra.(*Command).execute(0xc420448000, 0xc42040d510, 0x1, 0x1, 0xc420448000, 0xc42040d510)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/vendor/github.com/spf13/cobra/command.go:603 +0x439
k8s.io/kubernetes/vendor/github.com/spf13/cobra.(*Command).ExecuteC(0xc420123680, 0xc42040cf10, 0x1, 0x1)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/vendor/github.com/spf13/cobra/command.go:689 +0x367
k8s.io/kubernetes/vendor/github.com/spf13/cobra.(*Command).Execute(0xc420123680, 0xc420445f80, 0x2046fc0)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/vendor/github.com/spf13/cobra/command.go:648 +0x2b
k8s.io/kubernetes/cmd/kubectl/app.Run(0x0, 0x0)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/cmd/kubectl/app/kubectl.go:47 +0xd5
main.main()
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/cmd/kubectl/kubectl.go:26 +0x22
```

## Get命令
func (m *Helper) Get通过对RESTClient的调用，从而和kube-apiserver建立了联系
```go
func (m *Helper) Get(namespace, name string, export bool) (runtime.Object, error) {
	/*
		kubectl get node xxx 用Get
	*/
	req := m.RESTClient.Get().
		NamespaceIfScoped(namespace, m.NamespaceScoped).
		Resource(m.Resource).
		Name(name)
	if export {
		req.Param("export", strconv.FormatBool(export))
	}
	return req.Do().Get()
}
```

其调用栈如下所示
```txt
k8s.io/kubernetes/pkg/kubectl/resource.(*Helper).Get(0xc42000bc40, 0x178301f, 0x7, 0x7ffd58ea0671, 0x5, 0x0, 0x163eb60, 0xc42000ba01, 0xc4202bf580, 0xc420642ee8)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/resource/helper.go:57 +0xc1
k8s.io/kubernetes/pkg/kubectl/resource.(*Info).Get(0xc420420180, 0x7, 0x178301f)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/resource/visitor.go:143 +0x9a
k8s.io/kubernetes/pkg/kubectl/resource.RetrieveLazy(0xc420420180, 0x0, 0x0, 0x0, 0x0)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/resource/visitor.go:770 +0x42
k8s.io/kubernetes/pkg/kubectl/resource.DecoratedVisitor.Visit.func1(0xc420420180, 0x0, 0x0, 0xa, 0xc420643070)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/resource/visitor.go:369 +0x91
k8s.io/kubernetes/pkg/kubectl/resource.FlattenListVisitor.Visit.func1(0xc420420180, 0x0, 0x0, 0x28, 0xc4201d82d0)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/resource/visitor.go:458 +0x5c4
k8s.io/kubernetes/pkg/kubectl/resource.(*Info).Visit(0xc420420180, 0xc4201d82d0, 0x0, 0x40e66e)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/resource/visitor.go:138 +0x42
k8s.io/kubernetes/pkg/kubectl/resource.VisitorList.Visit(0xc4202bf590, 0x1, 0x1, 0xc4201d82d0, 0x1, 0xc4201d82d0)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/resource/visitor.go:216 +0x5b
k8s.io/kubernetes/pkg/kubectl/resource.(*VisitorList).Visit(0xc42020ee00, 0xc4201d82d0, 0x0, 0x1872db6)
	<autogenerated>:125 +0x6e
k8s.io/kubernetes/pkg/kubectl/resource.FlattenListVisitor.Visit(0x2048040, 0xc42020ee00, 0xc42000b0c0, 0xc42000bc00, 0xc42020ee01, 0xc42000bc00)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/resource/visitor.go:496 +0x94
k8s.io/kubernetes/pkg/kubectl/resource.(*FlattenListVisitor).Visit(0xc42020ee20, 0xc42000bc00, 0x18, 0x18)
	<autogenerated>:140 +0x6e
k8s.io/kubernetes/pkg/kubectl/resource.DecoratedVisitor.Visit(0x2048000, 0xc42020ee20, 0xc42020ee60, 0x3, 0x4, 0xc42020eec0, 0x40e601, 0xc42020eec0)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/resource/visitor.go:374 +0xd6
k8s.io/kubernetes/pkg/kubectl/resource.(*DecoratedVisitor).Visit(0xc4201d8270, 0xc42020eec0, 0x0, 0x10)
	<autogenerated>:160 +0x78
k8s.io/kubernetes/pkg/kubectl/resource.ContinueOnErrorVisitor.Visit(0x2047f00, 0xc4201d8270, 0xc4202bf600, 0x16223e0, 0x1796301)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/resource/visitor.go:412 +0xf1
k8s.io/kubernetes/pkg/kubectl/resource.(*ContinueOnErrorVisitor).Visit(0xc4202bf5c0, 0xc4202bf600, 0x11, 0x1785eb5)
	<autogenerated>:155 +0x65
k8s.io/kubernetes/pkg/kubectl/resource.(*Result).Infos(0xc420408fc0, 0x0, 0x0, 0x0, 0x0, 0x0)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/resource/result.go:131 +0xfd
k8s.io/kubernetes/pkg/kubectl/cmd.RunGet(0x205fd60, 0xc42020f440, 0x2047000, 0xc420024010, 0x2047000, 0xc420024018, 0xc420473d40, 0xc4202460e0, 0x2, 0x2, ...)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/cmd/get.go:484 +0x1f7e
k8s.io/kubernetes/pkg/kubectl/cmd.NewCmdGet.func1(0xc420473d40, 0xc4202460e0, 0x2, 0x2)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/pkg/kubectl/cmd/get.go:107 +0x95
k8s.io/kubernetes/vendor/github.com/spf13/cobra.(*Command).execute(0xc420473d40, 0xc420161f80, 0x2, 0x2, 0xc420473d40, 0xc420161f80)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/vendor/github.com/spf13/cobra/command.go:603 +0x439
k8s.io/kubernetes/vendor/github.com/spf13/cobra.(*Command).ExecuteC(0xc42013f680, 0xc420405920, 0x1, 0x1)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/vendor/github.com/spf13/cobra/command.go:689 +0x367
k8s.io/kubernetes/vendor/github.com/spf13/cobra.(*Command).Execute(0xc42013f680, 0xc42020f440, 0x2046fc0)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/vendor/github.com/spf13/cobra/command.go:648 +0x2b
k8s.io/kubernetes/cmd/kubectl/app.Run(0x0, 0x0)
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/cmd/kubectl/app/kubectl.go:47 +0xd5
main.main()
	/root/kubernetes-1.5.2/_output/local/go/src/k8s.io/kubernetes/cmd/kubectl/kubectl.go:26 +0x22
```




